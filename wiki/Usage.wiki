#summary How to use the plugin with TinyMCE
#labels Featured,Phase-Deploy

<wiki:toc max_depth="2" />

= Plugin Usage Instructions =

Start with a working instance of TinyMCE.  Create a folder in the tinyMCE plugins folder called *advimagescale*.  Download the latest plugin source from http://tinymce-plugin-advimagescale.googlecode.com/svn/trunk/editor_plugin_src.js and save the file to plugins/advimagescale/editor_plugin.js (remember to rename the file from editor_plugin_src.js to editor_plugin.js !).  Finally, add advimagescale to the TinyMCE.init "plugins" configuration parameter as shown in the full example below.

*Note that if you are using any of the `advimagescale_max_*` or `advimagescale_min_*` options and you wish for them to be immediately enforced upon TinyMCE initialization, then you _must_ set the _`cleanup_on_startup`_ configuration option to true.*

By default (with no options set), the plugin manages *all images* in the editor, forcing them to *maintain the same aspect ratio they started with*.

== Full example ==

This is a full example of all possible options (except for the `advimagescale_filter_*` options).   It assumes you have placed the advimagescale folder in your TinyMCE plugins directory.

{{{
tinyMCE.init({
    mode : "textareas",
    plugins: 'advimagescale',
    cleanup_on_startup: true,
    advimagescale_maintain_aspect_ratio: true, /* this is the default behavior */
    advimagescale_fix_border_glitch: true, /* also the default behavior */
    advimagescale_noresize_all: false, /* set to true to prevent all resizing on images */
    advimagescale_append_to_url: true,
    advimagescale_url_width_key: 'w',
    advimagescale_url_height_key: 'h',
    advimagescale_max_height: 200,
    advimagescale_max_width:  200,
    advimagescale_min_height: 20, 
    advimagescale_min_width:  20,
    advimagescale_loading_callback: function(imgNode) {
        alert(imgNode.src + ' is loading');
    },
    advimagescale_loaded_callback: function(imgNode) {
        alert(imgNode.src + ' is loaded');
    },
    advimagescale_resize_callback: function(editorInstance, imgNode) {
        alert('resized to ' + imgNode.width + 'x' + imgNode.height);
    }
});

<form>
	<textarea name="content">
		<!-- this image is managed by advimagescale -->
		<img src="http://mydomain.com/dynamic-image.php?id=1234" width="100" height="100" />
		<!-- this image size is locked with mce_noresize and cannot be resized -->
		<img mce_noresize="1" src="http://mydomain.com/images/picture.jpg" width="100" height="100" />
	</textarea>
</form>

}}}

== Placing advimagescale outside of your TinyMCE plugins folder ==

If you would prefer to place the advimagescale folder outside of your TinyMCE plugins folder, then load it via tinymce.PluginManager.load() and then prefix the plugin name with a dash in the plugins init option:

{{{
    tinymce.PluginManager.load('advimagescale', '/lib/advimagescale/editor_plugin_src.js');
    tinyMCE.init({
      ...
      plugins: '-advimagescale'
      ...
    });
}}} 

== Prevent image resizing (on some or all images) ==

Prevent image resizing on *specific IMG tags* by setting the mce_noresize="1" attribute on that IMG tag - for example <img src="" mce_noresize="1">. Note that the mce_noresize attribute will be removed before saving, so this option will *not* get saved for future edits.

Alternately, use *advimage_noresize_class* to specify a single image class name that is not resizable (i.e. <img src="" class="noresize">).  The default classname is 'noresize'.

To *prevent all images from being resized*, set *advimagescale_noresize_all* to true (this overrides all other plugin options since disallowing all resizes negates the need for the other features).  

These methods are preferable to the tinyMCE forum suggested method of stripping image width/height attributes because it does not strip these attributes.  (Stripping the width/height attributes results in failure of HTML/XHTML validation and slows down page loading).

== Restrict by class name ==

You may limit the plugin to only manage images with a specific class by using the advimagescale_filter_class configuration option.  For example, to only manage images with the class "scale_me", you would set:

{{{
    tinyMCE.init({
       /* same options as the first example, plus: */
       advimagescale_filter_class: "scale_me"
    });
}}}

== Restrict by image URL with a regular expression ==

Instead of limiting by image class name, you may define a regular expression pattern using *advimagescale_filter_src*.  If the image URL matches the pattern, then it is managed by the plugin.  Both advimagescale_filter_src and advimagescale_filter_class can be used at the same time for additional selectivity, if you require it (i.e. BOTH conditions must match for the image to be managed by the plugin).

{{{
    tinyMCE.init({
        /* sample options as the first example, plus: */
        advimagescale_filter_src: '\\d{3,}' /* image must have at least 3 digits in the URL */
    });
}}}

== All options ==
Note: *All advimagescale`_``*` options are optional.*  By default, the plugin only maintains image aspect ratios.  However, additional features exist to *restrict image resizing* on some or all images, *set minimum and maximum dimensions*, *append image dimensions to the querystring*, *trigger callbacks on image-related events* and *filter which images get managed by the plugin*.

|| *Configuration option* || *Type* || *Default* || *Description* ||
|| advimagescale_maintain_aspect_ratio || boolean || true || Whether to maintain image aspect ratio (default true) ||
|| advimagescale_append_to_url || boolean || false || Whether to append the image width/height to the IMG SRC. (i.e. `http://mydomain.com/images.php?id=123&w=120&h=120`). This is used for doing automatic server-side resampling of scaled images ||
|| advimagescale_url_width_key || string || 'w' || The querystring parameter to use when appending width to the URL ||
|| advimagescale_url_height_key || string || 'h' || The querystring parameter to use when appending width to the URL ||
|| advimagescale_fix_border_glitch || boolean || true || Fix the bug (described in #2 in the bug list below).  Most users will want this on (the default is true - so it is on by default). ||
|| *Specify min/max dimensions* ||||||||
|| advimagescale_max_height || integer || not set || Set a value to limit the maximum image height of all images ||
|| advimagescale_max_width || integer || not set || Set max image width ||
|| advimagescale_min_height || integer || not set || Set min image height ||
|| advimagescale_min_width || integer || not set || Set min image width ||
|| *Control which images are managed by plugin * ||||||||
|| advimagescale_filter_src || string || not set || A regular expression; all image SRC attributes that match this regexp will be managed by the plugin ||
|| advimagescale_filter_class || string || not set || A CSS class name; all IMG tags with this class will be managed by the plugin _(if not set, all images are managed by the plugin)_ ||
|| advimagescale_noresize_class || string || 'noresize' || A single class name that, if set on an image, tells the plugin to prevent resizing on that image ||
|| advimagescale_noresize_all || boolean || false || Set to true to prevent all image resizing in the editor (overrides all other functionality since all resizes will be prevented) ||
|| *Callbacks* ||||||||
|| advimagescale_loading_callback || function(imageNode) || not set || Callback function, called when an image begins reloading due to change of the image SRC (usually via advimagescale_append_to_url option) passes the DOM image node as parameter (often used to show a "please wait" dialog or disable form submission while an image is resizing in conjuction with the advimagescale_append_to_url option) ||
|| advimagescale_loaded_callback || function(imageNode) || not set || Callback function, called when an image URL has changed (usually via advimagescale_append_to_url) and has completed loading ||
|| advimagescale_resize_callback || function(editorInstance, imageNode) || not set || Callback function, called when an image has been resized and the new dimensions are available (via imageNode.width / imageNode.height) ||

== Server-side image resampling ==

The advimagescale_append_to_url option (and the configurable parameter names with advimagescale_url_width_key and advimagescale_url_height_key) provide a simple solution for auto-rescaling images on the server side.  

For example, you would begin by inserting an dynamic image URL (usually a PHP script) which performs resampling (if necessary) and then redirects to the properly sized image.  

Assuming the initially inserted image had its width and height attributes set to 100x100, advimagescale will immediately overwrite the source URL for that image from:

`http://mydomain.com/image.php?id=123`
to
`http://mydomain.com/image.php?id=123&w=100&h=100`

This signals your "image.php" script that it needs to serve image `#`123, resampled to 100x100 pixels.

Now, if the user scales the image up to 500x500, the URL will change to:

`http://mydomain.com/image.php?id=123&w=500&h=500`

... and your CMS will now know that it needs to resample the original source image for image `#`123 to 500x500 pixels, and then redirect to that image so the user receives an updated version to fit the new dimensions.

This feature is intended to allow seamless scaling up and down of images without loss of quality.

Use the *advimagescale_loading_callback* and *advimagescale_loaded_callback* callback options if you'd like to be notified when an image begins reloading and completes reloading.

== Bug Fixes ==

There are two browser bugs that we discovered while developing this plugin, and have implemented workarounds.  Specifically:

  # *Resize handles do not re-draw in Gecko*. When the plugin changes the image dimensions to maintain aspect ratio, Gecko does not move the resize handles to wrap the new image dimensions.  This has been worked around by forcing a redraw of the TinyMCE area.  The side effect is that this de-selects the image.  To continue further resizing, you must re-select the image by clicking on it.

  # *Resizing an image with a border adds border width to image width*.  This occurs only when an image has a border width set via the tinymce content_css directive or via an inline style.  This bug (or unexpected behavior, at least...) is present without this plugin, we are simply working around it here as a convenience.  This is corrected by automatically adjusting the image to reduce its width by the border width after each resize. The consequence in Gecko based browsers is that the image will be de-selected (as the plugin must force a tinyMCE redraw to move the resize handles into the correct location due to gecko bug #1 above).