(function(){var q=new Array();var s=new Array();var t;tinymce.create('tinymce.plugins.AdvImageScale',{init:function(c,d){c.onMouseUp.add(function(a,e){t=tinyMCE.activeEditor.selection.getNode();if(t.nodeName=='IMG'){setTimeout(function(){constrainSize(t)},100)}});if(c.getParam('advimagescale_append_to_url')){c.onPreProcess.add(function(b,o){tinymce.each(b.dom.select('img',o.node),function(a){constrainSize(a)})})}},getInfo:function(){return{longname:'Advanced Image Resize Helper',author:'Marc Hodgins',authorurl:'http://www.hodginsmedia.com',infourl:'http://code.google.com/p/tinymce-plugin-advimagescale',version:'1.0'}}});tinymce.PluginManager.add('advimagescale',tinymce.plugins.AdvImageScale);function storeDimensions(a){var b=tinyMCE.activeEditor;var c=b.dom;if(!q[a]){q[a]=s[a]={width:c.getAttrib(a,'width'),height:c.getAttrib(a,'height')}}return true}function constrainSize(a){var b=tinyMCE.activeEditor;var c=b.dom;storeDimensions(a);var d=b.getParam('advimagescale_filter_src');if(d){var r=new RegExp(d);if(!a.src.match(r))return}var e=b.getParam('advimagescale_filter_class');if(e){if(!c.hasClass(a,e))return}var f=b.getParam('advimagescale_max_width');var g=b.getParam('advimagescale_max_height');var h=b.getParam('advimagescale_min_width');var i=b.getParam('advimagescale_min_height');var j=maintainAspect(c.getAttrib(a,'width'),c.getAttrib(a,'height'),a,f,g,h,i);var k=(c.getAttrib(a,'width')!=j.width||c.getAttrib(a,'height')!=j.height);c.setAttrib(a,'width',j.width);c.setAttrib(a,'height',j.height);if(b.getParam('advimagescale_append_to_url')){appendToUri(a,j.width,j.height)}if(k&&tinymce.isGecko){b.execCommand('mceRepaint',false)}s[a]={width:c.getAttrib(a,'width'),height:c.getAttrib(a,'height')}}function appendToUri(a,w,h){var b=tinyMCE.activeEditor;var c=b.dom;var d=c.getAttrib(a,'src');var e=b.getParam('advimagescale_filter_src');if(e){var r=new RegExp(e);if(!d.match(r))return}var f=b.getParam('advimagescale_filter_class');if(f){var r=new RegExp(f);if(!c.hasClass(a,f))return}var g=b.getParam('advimagescale_url_width_key','w');d=setQueryParam(d,g,w);var i=b.getParam('advimagescale_url_height_key','h');d=setQueryParam(d,i,h);c.setAttrib(a,'src',d)}function setQueryParam(a,b,c){if(!a.match(/\?/))a+='?';if(!a.match(new RegExp('([\?&])'+b+'='))){if(!a.match(/[&\?]$/))a+='&';a+=b+'='+escape(c)}else a=a.replace(new RegExp('([\?\&])'+b+'=[^&]*'),'$1'+b+'='+escape(c));return a}function maintainAspect(w,h,a,b,c,d,e){var f=q[a].width;var g=q[a].height;var i=f/g;var j=s[a].width;var k=s[a].height;var l=Math.abs(j-w);var m=Math.abs(k-h);var n=Math.abs(l/j);var o=Math.abs(m/k);var p={};if(l||m){if(n>o){p={width:w,height:Math.round(w/i)}}else{p={width:Math.round(h*i),height:h}}}else{p={width:w,height:h}}if(b&&p.width>b){p={width:b,height:Math.round(b/i)}}if(c&&p.height>c){p={width:Math.round(c/i),height:c}}if(d&&p.width<d){p={width:d,height:Math.round(d/i)}}if(e&&p.height<e){p={height:Math.round(e/i),width:e}}return p}})();